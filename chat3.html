<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>聊天窗口</title>
		<link href="css/mui.css" rel="stylesheet" />
		<link href="css/mui.imageviewer.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/stylejxt.css" />
		<script src="js/testplugin.js" type="text/javascript"></script>
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			
			.mui-icon-left-nav {
				color: #AFAFAF;
			}
			
			footer {
				position: fixed;
				width: 100%;
				height: 130px;
				min-height: 50px;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
			}
			
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			
			.footer-center {
				height: 40px;
				padding: 0 10px;
				/*padding-right: 0;
				overflow: hidden;*/
			}
			
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 10px;
			}
			
			.footer-center .input-text {
				width: 75%;
				background: #fff;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
				border: none 0;
			}
			
			.footer-center #fasong {
				width: 23%;
				height: 40px;
				border: none 0;
				border-radius: 10px;
				/*background: #AC1A1A;*/
				background-color: transparent;
				color: #666;
				font-size: 17px;
			}
			
			.footer-center .input-sound {
				background-color: #eee;
			}
			
			.mui-content {
				height: 100%;
				padding: 44px 0px 63px 0px;
				overflow: auto;
				background-color: #eaeaea;
			}
			
			#msg-list {
				height: 94%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
				/*position:absolute;*/
			}
			
			.msg-item {
				padding: 8px;
				clear: both;
			}
			
			.msg-item .mui-item-clear {
				clear: both;
			}
			
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				/*border: solid 1px #d3d3d3;*/
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				/*padding: 3px;*/
				color: #ddd;
			}
			
			.msg-item .msg-user-img {
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #9EEA6A;
				color: #333;
				border-color: #90D862;
			}
			
			footer .mui-icon {
				color: #000;
			}
			
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			
			footer .mui-icon-paperplane {
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			
			.r-sigh {
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			
			.rprogress-sigh {
				background-image: none !important;
			}
			
			.rprogress-sigh .rschedule {
				display: none !important;
			}
			
			.rprogress-sigh .r-sigh {
				display: block !important;
			}
			
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			
			.cancel {
				background-color: darkred;
			}
			
			#msg-list img {
				border-radius: 8px;
			}
			
			.mui-popover {
				height: 120px;
				width: 315px;
			}
			
			.mui-popover .mui-popover-arrow:after {
				position: absolute;
				width: 0px;
				height: 0px;
				content: ' ';
				-webkit-transform: rotate(45deg);
				transform: rotate(45deg);
				border-radius: 3px;
				background: #f7f7f7;
			}
			/*footer*/
			
			footer {
				height: 98px
			}
			
			.chat-footer {
				padding-top: 8px;
				height: 95px;
				border-top: 1px solid #ddd;
				z-index: 101;
			}
			
			.chat-footer li {
				width: 24%;
			}
			
			.chat-footer li img {
				margin-top: 10px;
			}
			
			.footer-center .input-text {
				width: 82%;
			}
			
			.footer-center #fasong {
				width: 15%;
			}
			
			.mui-icon-left-nav {
				color: #9b9b9b;
			}
			
			.chat-footer li {
				width: 33%;
			}
		</style>
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 id="title" class="mui-title">消息</h1>
			<!--<a id="check_data" style="display: none;" class="mui-icon mui-pull-right mui-icon-bars"></a>-->
			<!--<a id="check_data" style="display: none;"><span class="mui-icon mui-icon-plusempty mui-pull-right"></span></a>-->
		</header>
		<pre id='h'></pre>
		<script id='msg-template' type="text/template">
			<% for(var i in record){ var item=record[i]; %>
			<div class="msg-item <%= (item.sender=='self'?' msg-item-self':'') %>" msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>'>
				<% if(item.sender=='self' ) { %>
				<!--<i class="msg-user mui-icon mui-icon-person"></i>-->
				<img class="msg-user" src="<%= avatar %>" alt="" />
				<% } else { %>
				<img class="msg-user-img" src="<%= friendAvatar %>" alt="" />
				<% } %>
				<div class="msg-content">
					<div class="msg-content-inner">
						<% if(item.type=='text' ) { %>
						<%=( item.content|| '&nbsp;&nbsp;') %>
						<% } else if(item.type=='image' ) { %>
						<img class="msg-content-image" src="<%=(item.content)%>" style="max-width: 100px;" />
						<% } else if(item.type=='video' ) { %>
						<video style="max-width: 100px;" />
						<% } else if(item.type=='sound' ) { %>
						<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
						<span class="play-state">点击播放</span>
						<% } %>
					</div>
					<div class="msg-content-arrow"></div>
				</div>
				<div class="mui-item-clear"></div>
			</div>
			<% } %>
		</script>
		<div class="mui-content">
			<span id="unreadMsgNum" style="font-size: 17px; top:70px;left:75%;border-radius: 20px; padding:0 5px;color: white;background-color: #9FBF3E;position:absolute; z-index: 9999;"></span>
			<div id='msg-list'>
			</div>
		</div>
		<footer>
			<div class="chat-footer">
				<div id="footerDivForText" class="footer-center">
					<textarea id='msg-text' type="text" class='input-text'></textarea>
					<button type="button" id="fasong">发送</button>
				</div>
				<div id="footerDivforSound" class="footer-center" style="display: none;">
					<button id='msg-sound' type="button" class='input-sound' style="width:85%;">按住说话</button>
					<label id="textLabel">
						<i class="mui-icon mui-icon-compose" style="margin-top: 3px;font-size: 35px"></i>
					</label>
				</div>
				<ul>
					<!--<li id="micImg" ><img src="images/yuyin.png"/></li>-->
					<li id="picture"><img src="images/tupian.png" /></li>
					<li id="camera"><img src="images/xiangji.png" /></li>
					<li id="video"></li>
					<!--<li id="expression"><a href="#bottomPopover"><img src="images/biaoqing.png"/></a></li>-->
					<li id="expression">
						<a><img src="images/biaoqing.png" /></a>
					</li>
					<!--<li><img src="images/biaoqing.png"/></li>-->
				</ul>
			</div>
		</footer>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<div style="position: absolute;bottom: 90px;z-index: 9999;right: 0;width: 100%;">
			<div id="bottomPopover" class="mui-popover mui-popover-bottom" style="position: static;width: 100%;">
				<!--<div class="mui-popover-arrow"></div>-->
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<table border="0" cellspacing="0" cellpadding="0" style="width: 100%;">
							<tr>
								<td><img src='arclist/1.gif' /></td>
								<td><img src='arclist/2.gif' /></td>
								<td><img src='arclist/3.gif' /></td>
								<td><img src='arclist/4.gif' /></td>
								<td><img src='arclist/5.gif' /></td>
								<td><img src='arclist/6.gif' /></td>
								<td><img src='arclist/7.gif' /></td>
								<td><img src='arclist/8.gif' /></td>
								<td><img src='arclist/9.gif' /></td>
								<td><img src='arclist/10.gif' /></td>
								<td><img src='arclist/11.gif' /></td>
								<td><img src='arclist/12.gif' /></td>
								<td><img src='arclist/13.gif' /></td>
							</tr>
							<tr>
								<td><img src='arclist/14.gif' /></td>
								<td><img src='arclist/15.gif' /></td>
								<td><img src='arclist/16.gif' /></td>
								<td><img src='arclist/17.gif' /></td>
								<td><img src='arclist/18.gif' /></td>
								<td><img src='arclist/19.gif' /></td>
								<td><img src='arclist/20.gif' /></td>
								<td><img src='arclist/21.gif' /></td>
								<td><img src='arclist/22.gif' /></td>
								<td><img src='arclist/23.gif' /></td>
								<td><img src='arclist/24.gif' /></td>
								<td><img src='arclist/25.gif' /></td>
								<td><img src='arclist/26.gif' /></td>
							</tr>
							<tr>
								<td><img src='arclist/27.gif' /></td>
								<td><img src='arclist/28.gif' /></td>
								<td><img src='arclist/29.gif' /></td>
								<td><img src='arclist/30.gif' /></td>
								<td><img src='arclist/31.gif' /></td>
								<td><img src='arclist/32.gif' /></td>
								<td><img src='arclist/33.gif' /></td>
								<td><img src='arclist/34.gif' /></td>
								<td><img src='arclist/35.gif' /></td>
								<td><img src='arclist/36.gif' /></td>
								<td><img src='arclist/37.gif' /></td>
								<td><img src='arclist/38.gif' /></td>
								<td><img src='arclist/39.gif' /></td>
							</tr>
							<tr>
								<td><img src='arclist/40.gif' /></td>
								<td><img src='arclist/41.gif' /></td>
								<td><img src='arclist/42.gif' /></td>
								<td><img src='arclist/43.gif' /></td>
								<td><img src='arclist/44.gif' /></td>
								<td><img src='arclist/45.gif' /></td>
								<td><img src='arclist/46.gif' /></td>
								<td><img src='arclist/47.gif' /></td>
								<td><img src='arclist/48.gif' /></td>
								<td><img src='arclist/49.gif' /></td>
								<td><img src='arclist/50.gif' /></td>
								<td><img src='arclist/51.gif' /></td>
								<td><img src='arclist/52.gif' /></td>
							</tr>
							<tr>
								<td><img src='arclist/53.gif' /></td>
								<td><img src='arclist/54.gif' /></td>
								<td><img src='arclist/55.gif' /></td>
								<td><img src='arclist/56.gif' /></td>
								<td><img src='arclist/57.gif' /></td>
								<td><img src='arclist/58.gif' /></td>
								<td><img src='arclist/59.gif' /></td>
								<td><img src='arclist/60.gif' /></td>
								<td><img src='arclist/61.gif' /></td>
								<td><img src='arclist/62.gif' /></td>
								<td><img src='arclist/63.gif' /></td>
								<td><img src='arclist/64.gif' /></td>
								<td><img src='arclist/65.gif' /></td>
							</tr>
						</table>
					</div>
				</div>
			</div>
		</div>
		<script src="js/mui.js"></script>
		<script src="js/base.js"></script>
		<!--<script src="js/Socket.js"></script>-->
		<script src="js/DateConvert.js"></script>
		<script src="js/mui.imageViewer.js"></script>
		<script src="js/arttmpl.js"></script>
		<script src="js/expression.js"></script>
		<script src="js/dbConnect.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/ytx.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/jquery.js" type="text/javascript"></script>
		<script src="http://app.cloopen.com/im50/ytx-web-im-min-new.js"></script>
		<script type="text/javascript" charset="utf-8">
			mui.init();
			mui('.mui-scroll-wrapper').scroll();

			//底部添加展开
			var onOff = false;
			$('.tj').click(function() {
				if(onOff == true) {
					$('.box').show();
					$('.chat-footer').css("height", "130px")
					onOff = false;
				} else {
					$('.box').hide();
					$('.chat-footer').css("height", "58px")
					onOff = true;
				}
			})

			mui("table").on('tap', 'img', function() {
				var msgText = document.getElementById("msg-text");
				var indexOfPosition = getCursortPosition(msgText);

				var left = msgText.value.substring(0, indexOfPosition);
				var right = msgText.value.substring(indexOfPosition);
				var imgSrc = this.getAttribute("src");
				var imgString = imgSrc + "";
				var start = imgString.indexOf("/");
				var end = imgString.indexOf(".");
				var num = imgString.substring(start + 1, end);
				var emojiName = emoji[num];

				document.getElementById("msg-text").value = left + "[" + emojiName + "]" + right;
			});

			var send = function(msg) {
				record.push(msg);
				bindMsgList();
			};

			//var friendAvatar = localStorage.getItem("avatar" + friendId);
			var friendAvatar;
			var bindMsgList = function() {
				//绑定数据:
				ui.areaMsgList.innerHTML = template('msg-template', {
					"record": record,
					"avatar": avatar,
					"friendAvatar": friendAvatar
				});
				var msgItems = ui.areaMsgList.querySelectorAll('.msg-item');
				[].forEach.call(msgItems, function(item, index) {
					item.addEventListener('tap', function(event) {
						msgItemTap(item, event);
					}, false);
				});

				//发送图片消息时，点击所发图片可查看大图
				imageViewer.findAllImage();
				ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
			};

			var msgItemTap = function(msgItem, event) {
				var msgType = msgItem.getAttribute('msg-type');
				var msgContent = msgItem.getAttribute('msg-content');

				console.log("msgContent = " + msgContent);

				if(msgType == 'sound') {
					var playState = msgItem.querySelector('.play-state');
					playState.innerText = '正在播放...';

					if(mui.os.ios) {
						//若为IOS端，则先下载音频，再根据本地路径创建音频播放对象
						var dtask = plus.downloader.createDownload(msgContent, {},
							function(d, status) {
								// 下载完成
								if(status == 200) {
									msgContent = d.filename;
									var player = plus.audio.createPlayer(msgContent);
									player.play(function() {
										playState.innerText = '点击播放';
									}, function(e) {
										playState.innerText = '点击播放';
									});
								}
							});
						dtask.start();
					} else {
						var player = plus.audio.createPlayer(msgContent);
						player.play(function() {
							playState.innerText = '点击播放';
						}, function(e) {
							playState.innerText = '点击播放';
						});
					}
				} else if(msgType == 'video') {
					//alert("msgContent = " + msgContent);

					if(mui.os.ios) {
						mui.openWindow({
							url: 'videoPlay.html',
							id: 'videoPlay.html',
							extras: {
								videoUrl: msgContent
							}
						});
					} else {
						var floatw = plus.webview.create("videoPlay.html", "videoPlay.html", {
							margin: "auto",
							scrollIndicator: 'none',
							scalable: false,
							popGesture: 'none'
						});

						mui.fire(floatw, 'zhanshi', { videoUrl: msgContent });
						floatw.addEventListener("loaded", function() {
							floatw.show('fade-in', 300);
							floatw = null;
						}, false);
					}
				}
			};

			var ui = {
				body: document.querySelector('body'),
				footer: document.querySelector('footer'),
				btnMsgType: document.querySelector('#msg-type'),
				boxMsgText: document.querySelector('#msg-text'),
				boxMsgSound: document.querySelector('#msg-sound'),
				btnMsgImage: document.querySelector('#msg-image'),
				areaMsgList: document.querySelector('#msg-list'),
				boxSoundAlert: document.querySelector('#sound-alert'),
				h: document.querySelector('#h'),
				content: document.querySelector('.mui-content')
			};

			var imageViewer = new mui.ImageViewer('.msg-content-image', { dbl: false });

			//登录云通讯
			function login(user_account) {
				var wt = plus.nativeUI.showWaiting("", {});
				var timestamp = getTimeStamp();
				var appToken = '5d7cedbd6bd04a65d8f76fa049a415b1'; //开发token
				var sig = hex_md5(appid + user_account + timestamp + appToken);

				var loginBuilder = new RL_YTX.LoginBuilder();
				loginBuilder.setType(1);
				loginBuilder.setUserName(user_account);
				loginBuilder.setSig(sig);
				loginBuilder.setTimestamp(timestamp);

				RL_YTX.login(loginBuilder,
					function(obj) {
						wt.close();
						console.log("单聊页面登录云通讯成功");
						RL_YTX.onMsgReceiveListener(function(obj) {
							console.log("接收到的消息obj = " + JSON.stringify(obj));

							//判断是群消息还是好友消息
							var isGroupMsg = ("g" == obj.msgReceiver.substr(0, 1)); //判断群消息标示

							if(!isGroupMsg && obj.msgType != 12) {
								if(friendName == obj.msgSender) {
									//如果是当前好友消息，则将消息插入数据库，并在页面显示
									var db = openDatabase('MSG_DATABASE', '1.0.0', 'MSG_DATABASE', 5 * 1024 * 1024);
									var sql = "select * from IM_MSG_INFO where times = '" + obj.msgDateCreated + "'";
									db.transaction(function(tx) {
										tx.executeSql(sql, [],
											function(tx, result) {
												if(result.rows.length == 0) {
													//如果为文字消息
													var msgType = obj.msgType;
													if(1 == msgType || 0 == msgType) {
														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: obj.msgContent,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "1"
														}]);
														record.push({
															sender: 'zs',
															type: 'text',
															content: obj.msgContent
														});
														bindMsgList();
													} else if(4 == msgType) {
														//如果为图片消息
														var url = obj.msgFileUrl;

														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: url,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "1"
														}]);
														record.push({
															sender: 'zs',
															type: 'image',
															content: url
														});
														bindMsgList();
													} else if(2 == msgType) {
														//如果为语音消息
														var url = obj.msgFileUrl;

														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: url,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "1"
														}]);
														record.push({
															sender: 'zs',
															type: 'sound',
															content: url
														});
														bindMsgList();
													} else if(3 == msgType) {
														//如果为视频消息
														var url = obj.msgFileUrl;

														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: url,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "1"
														}]);
														record.push({
															sender: 'zs',
															type: 'video',
															content: url
														});
														bindMsgList();
													}
												}
											}, null);
									});
								} else {
									//若不是当前好友消息，则将消息插入数据库，并标记为未读
									var db = openDatabase('MSG_DATABASE', '1.0.0', 'MSG_DATABASE', 5 * 1024 * 1024);
									var sql = "select * from IM_MSG_INFO where times = '" + obj.msgDateCreated + "'";
									db.transaction(function(tx) {
										tx.executeSql(sql, [],
											function(tx, result) {
												if(result.rows.length == 0) {
													//如果为文字消息
													var msgType = obj.msgType;
													if(1 == msgType || 0 == msgType) {
														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: obj.msgContent,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "2"
														}]);
													} else if(4 == msgType) {
														//如果为图片消息
														var url = obj.msgFileUrl;

														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: url,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "2"
														}]);
													} else if(2 == msgType) {
														//如果为语音消息
														var url = obj.msgFileUrl;

														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: url,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "2"
														}]);
													} else if(3 == msgType) {
														//如果为视频消息
														var url = obj.msgFileUrl;

														//插入数据库
														db = new lanxDB('MSG_DATABASE');
														db.switchTable('IM_MSG_INFO').insertData([{
															friendUserName: obj.msgSender,
															type: "2",
															msg: url,
															times: obj.msgDateCreated,
															msgtype: obj.msgType + "",
															status: "2"
														}]);
													}
												}
											}, null);
									});
								}
							} else if(isGroupMsg && obj.msgType != 12) {
								//如果是群消息，则将消息插入数据库，并标记为未读
								var db = openDatabase('MSG_DATABASE', '1.0.0', 'MSG_DATABASE', 5 * 1024 * 1024);
								var sql = "select * from GROUP_MSG_INFO where times = '" + obj.msgDateCreated + "'";
								db.transaction(function(tx) {
									tx.executeSql(sql, [],
										function(tx, result) {
											if(result.rows.length == 0) {
												db = new lanxDB('MSG_DATABASE');

												//如果为文字消息
												var msgType = obj.msgType;
												if(1 == msgType || 0 == msgType) {
													//插入数据库
													db.switchTable('GROUP_MSG_INFO').insertData([{
														ytxGroupId: obj.msgReceiver,
														sender: obj.msgSender,
														type: "2",
														msg: obj.msgContent,
														times: obj.msgDateCreated,
														msgtype: obj.msgType + "",
														status: "2"
													}]);
												} else if(4 == msgType) {
													//如果为图片消息
													db.switchTable('GROUP_MSG_INFO').insertData([{
														ytxGroupId: obj.msgReceiver,
														sender: obj.msgSender,
														type: "2",
														msg: obj.msgFileUrl,
														times: obj.msgDateCreated,
														msgtype: obj.msgType + "",
														status: "2"
													}]);
												} else if(2 == msgType) {
													//如果为语音消息
													db.switchTable('GROUP_MSG_INFO').insertData([{
														ytxGroupId: obj.msgReceiver,
														sender: obj.msgSender,
														type: "2",
														msg: obj.msgFileUrl,
														times: obj.msgDateCreated,
														msgtype: obj.msgType + "",
														status: "2"
													}]);
												} else if(3 == msgType) {
													//如果为视频消息
													db.switchTable('GROUP_MSG_INFO').insertData([{
														ytxGroupId: obj.msgReceiver,
														sender: obj.msgSender,
														type: "2",
														msg: obj.msgFileUrl,
														times: obj.msgDateCreated,
														msgtype: obj.msgType + "",
														status: "2"
													}]);
												}
											}
										}, null);
								});
							}
						});

						RL_YTX.onNoticeReceiveListener(function(obj) {
							//收到群组通知
						});

						RL_YTX.onConnectStateChangeLisenter(function(obj) {
							//连接状态变更
							// obj.code;//变更状态 1 断开连接 2 重连中 3 重连成功 4 被踢下线 5 断开连接，需重新登录
							// 断线需要人工重连
						});
					},
					function(obj) {
						wt.close();
						//console.log("登录时出错 --》 错误码： " + obj.code + "; 错误描述：" + obj.msg);
					});
			}

			//压缩照片
			function compressImage(url) {
				var timestamp = (new Date()).valueOf();
				var postfix = url.substr(url.lastIndexOf('.'), url.length);
				var dst = url.substr(0, url.lastIndexOf('/') + 1) + timestamp + postfix;

				plus.zip.compressImage({
						src: url,
						dst: dst,
						quality: 30
					},
					function() {
						sendImgMsg(dst);
					},
					function(error) {
						//压缩失败上传原图
						sendImgMsg(url);
						console.log(JSON.stringfy(error));
					});
			}

			//发送图片消息
			function sendImgMsg(path) {
				var wt = plus.nativeUI.showWaiting("正在发送图片消息", {});

				plus.io.resolveLocalFileSystemURL(path, function(entry) {
					entry.file(function(file) {
						var newPath = entry.toLocalURL();
						var img = new Image();
						img.src = newPath;
						var tempimg;
						img.onload = function() {
							var canvas = document.createElement("canvas");
							canvas.width = img.width;
							canvas.height = img.height;
							var ctx = canvas.getContext("2d");
							ctx.drawImage(img, 0, 0, img.width, img.height);
							tempimg = canvas.toDataURL("image/jpeg");

							var arr = tempimg.split(',');
							var mime = arr[0].match(/:(.*?);/)[1];
							var bstr = atob(arr[1]);
							var n = bstr.length;
							var u8arr = new Uint8Array(n);

							while(n--) {
								u8arr[n] = bstr.charCodeAt(n);
							}

							var fileBlob = new Blob([u8arr], { type: mime });

							//新建消息体对象
							var obj = new RL_YTX.MsgBuilder();
							//设置自定义消息id
							var times = new Date().getTime();
							obj.setId(times);
							//设置发送的消息类型1文本消息4 图片消息6 附件消息
							obj.setType(4);
							//设置接收者
							obj.setReceiver(friendName);

							obj.setFile(fileBlob);

							obj.setFileName(file.name);
							RL_YTX.sendMsg(obj, function(returnObj) {
								console.log("发送成功 fileUrl = " + JSON.stringify(returnObj));
								wt.close();
								send({
									sender: 'self',
									type: 'image',
									content: returnObj.fileUrl
								});
								var db = new lanxDB('MSG_DATABASE');
								db.switchTable('IM_MSG_INFO')
									.insertData([{
										friendUserName: friendName,
										type: "1",
										msg: returnObj.fileUrl,
										times: times + "",
										msgtype: "4",
										status: "1"
									}]);
							}, function(obj) {
								wt.close();
								mui.toast("发送失败");
								//失败
								console.log("发送失败" + "----->错误码： " + obj.code + "; 错误描述：" + obj.msg);

							}, function(sended, total) {
								console.log("发送总大小total：" + total + "----------发送当前进度:" + sended);
							});
						}
					});
				}, function(e) {
					wt.close();
					mui.toast("发送失败");
					console.log("Resolve file URL failed: " + e.message);
				});
			}

			//发送语音消息
			function sendVoiceMsg(path) {
				plus.io.resolveLocalFileSystemURL(path, function(entry) {
					console.log("path = " + path);
					entry.file(function(file) {
						var reader = new plus.io.FileReader();
						reader.onloadend = function(e) {
							console.log("e = " + e.target.result);
							var dataurl = e.target.result;
							var arr = dataurl.split(','),
								mime = arr[0].match(/:(.*?);/)[1],
								bstr = atob(arr[1]),
								n = bstr.length,
								u8arr = new Uint8Array(n);

							while(n--) {
								u8arr[n] = bstr.charCodeAt(n);
							}
							var fileBlob = new Blob([u8arr], { type: mime });

							//新建消息体对象
							var obj = new RL_YTX.MsgBuilder();
							//设置自定义消息id
							var times = new Date().getTime();
							obj.setId(times);
							//设置发送的消息类型1文本消息2语音消息4 图片消息6 附件消息
							obj.setType(2);
							//设置接收者
							obj.setReceiver(friendName);

							obj.setFile(fileBlob);

							obj.setFileName(file.name);
							RL_YTX.sendMsg(obj, function(returnObj) {
								console.log("returnObj -----------> " + JSON.stringify(returnObj));
								send({
									sender: 'self',
									type: 'sound',
									content: returnObj.fileUrl
								});

								var db = new lanxDB('MSG_DATABASE');
								db.switchTable('IM_MSG_INFO').insertData([{
									friendUserName: friendName,
									type: "1",
									msg: returnObj.fileUrl,
									times: times + "",
									msgtype: "2",
									status: "1"
								}]);
							}, function(obj) {
								//失败
								console.log("发送失败" + "----->错误码： " + obj.code + "; 错误描述：" + obj.msg);

							}, function(sended, total) {});
						};
						reader.readAsDataURL(file);
					});
				}, function(e) {
					//console.log("Resolve file URL failed: " + e.message);
				});
			}

			//发送语音消息（IOS端）
			function sendVoiceMsgForIOS() {
				var wt = plus.nativeUI.showWaiting("正在发送语音消息");
				plus.io.requestFileSystem(plus.io.PUBLIC_DOCUMENTS, function(fs) {
						fs.root.getFile("myRecord.wav", { create: false }, function(fileEntry) {
								fileEntry.file(function(file) {
										//var fileName = file.name;//获取文件名

										var reader = new plus.io.FileReader();
										reader.onloadend = function(e) {
											//file.close();//关闭文件对象，释放系统资源。

											var dataurl = e.target.result;
											var arr = dataurl.split(','),
												mime = arr[0].match(/:(.*?);/)[1],
												bstr = atob(arr[1]),
												n = bstr.length,
												u8arr = new Uint8Array(n);

											while(n--) {
												u8arr[n] = bstr.charCodeAt(n);
											}
											var fileBlob = new Blob([u8arr], { type: mime });

											//新建消息体对象
											var obj = new RL_YTX.MsgBuilder();
											//设置自定义消息id
											var times = new Date().getTime();
											obj.setId(times);
											//设置发送的消息类型1文本消息2语音消息4 图片消息6 附件消息
											obj.setType(2);
											//设置接收者
											obj.setReceiver(friendName);

											obj.setFile(fileBlob);

											obj.setFileName(file.name);
											RL_YTX.sendMsg(obj, function(returnObj) {
												wt.close();
												send({
													sender: 'self',
													type: 'sound',
													content: returnObj.fileUrl
												});

												var db = new lanxDB('MSG_DATABASE');
												db.switchTable('IM_MSG_INFO').insertData([{
													friendUserName: friendName,
													type: "1",
													msg: returnObj.fileUrl,
													times: times + "",
													msgtype: "2",
													status: "1"
												}]);
											}, function(obj) {
												wt.close();
												//失败
												//alert("发送失败" + "----->错误码： " + obj.code + "; 错误描述：" + obj.msg);

											}, function(sended, total) {});
										};
										reader.readAsDataURL(file);
									},
									function(e) {
										wt.close();
										//alert("错误1111111111 ----》 " + e.message);
									});
							},
							function(e) {
								wt.close();
								//alert("错误22222222 ----》 " + e.message);
							});
					},
					function(e) {
						wt.close();
						//alert("Request file system failed: " + e.message);
					});
			}

			//发送视频消息
			function sendVideoMsg(path) {
				var wt = plus.nativeUI.showWaiting("视频消息");
				plus.io.resolveLocalFileSystemURL(path, function(entry) {
					wt.close();
					console.log("进入发送视频消息 path = " + path);
					entry.file(function(file) {
						var reader = new plus.io.FileReader();
						reader.onloadend = function(e) {
							console.log("e = " + e.target.result);
							var dataurl = e.target.result;
							var arr = dataurl.split(','),
								mime = arr[0].match(/:(.*?);/)[1],
								bstr = atob(arr[1]),
								n = bstr.length,
								u8arr = new Uint8Array(n);

							while(n--) {
								u8arr[n] = bstr.charCodeAt(n);
							}
							var fileBlob = new Blob([u8arr], { type: mime });

							//新建消息体对象
							var obj = new RL_YTX.MsgBuilder();
							//设置自定义消息id
							var times = new Date().getTime();
							obj.setId(times);
							//设置发送的消息类型1文本消息2语音消息 3 视频消息 4 图片消息6 附件消息
							obj.setType(3);
							//设置接收者
							obj.setReceiver(friendName);

							obj.setFile(fileBlob);

							obj.setFileName(file.name);
							RL_YTX.sendMsg(obj, function(returnObj) {
								console.log("发送视频消息成功  returnObj = " + JSON.stringify(returnObj));

								send({
									sender: 'self',
									type: 'video',
									content: returnObj.fileUrl
								});

								var db = new lanxDB('MSG_DATABASE');
								db.switchTable('IM_MSG_INFO').insertData([{
									friendUserName: friendName,
									type: "1",
									msg: returnObj.fileUrl,
									times: times + "",
									msgtype: "3",
									status: "1"
								}]);
							}, function(obj) {
								//失败
								console.log("发送失败" + "----->错误码： " + obj.code + "; 错误描述：" + obj.msg);

							}, function(sended, total) {

							});
						};
						reader.readAsDataURL(file);
					});
				}, function(e) {
					wt.close();
					console.log("Resolve file URL failed: " + e.message);
				});
			}

			//发送视频消息（IOS端）
			function sendVideoMsgForIOS() {
				var wt = plus.nativeUI.showWaiting("正在发送视频消息");
				plus.io.requestFileSystem(plus.io.PUBLIC_DOCUMENTS, function(fs) {
						fs.root.getFile('hello.mp4', { create: false }, function(fileEntry) {
							fileEntry.file(function(file) {
								var reader = new plus.io.FileReader();
								reader.onloadend = function(e) {
									//console.log("e = " + e.target.result);
									var dataurl = e.target.result;
									var arr = dataurl.split(','),
										mime = arr[0].match(/:(.*?);/)[1],
										bstr = atob(arr[1]),
										n = bstr.length,
										u8arr = new Uint8Array(n);

									while(n--) {
										u8arr[n] = bstr.charCodeAt(n);
									}
									var fileBlob = new Blob([u8arr], { type: mime });

									//新建消息体对象
									var obj = new RL_YTX.MsgBuilder();
									//设置自定义消息id
									var times = new Date().getTime();
									obj.setId(times);
									//设置发送的消息类型1文本消息2语音消息 3 视频消息 4 图片消息6 附件消息
									obj.setType(3);
									//设置接收者
									obj.setReceiver(friendName);

									obj.setFile(fileBlob);

									obj.setFileName(file.name);
									RL_YTX.sendMsg(obj, function(returnObj) {
										//alert("发送视频消息成功 8687687 returnObj = " + JSON.stringify(returnObj));
										wt.close();
										send({
											sender: 'self',
											type: 'video',
											content: returnObj.fileUrl
										});

										var db = new lanxDB('MSG_DATABASE');
										db.switchTable('IM_MSG_INFO').insertData([{
											friendUserName: friendName,
											type: "1",
											msg: returnObj.fileUrl,
											times: times + "",
											msgtype: "3",
											status: "1"
										}]);
									}, function(obj) {
										//失败
										wt.close();
										//alert("发送失败" + "----->错误码： " + obj.code + "; 错误描述：" + obj.msg);

									}, function(sended, total) {});
								};
								reader.readAsDataURL(file);
							});
						});
					},
					function(e) {
						wt.close();
						//	alert("Request file system failed: " + e.message);
					});
			}

			var MIN_SOUND_TIME = 800;
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});

			template.config('escape', false);
			var title = document.getElementById("title");
			var friendId = "";
			var gid = "";
			var userId = "";
			var fAvatar = "";
			var state = "";
			var startNum = 0;
			var friendName = "";
			var unreadMsgNum = 0;
			var avatar; //用户头像

			//重写mui.back方法
			var old_back = mui.back;
			mui.back = function() {
				//将该好友的未读消息在数据库中修改为已读
				var db = new lanxDB('MSG_DATABASE');
				db.switchTable('IM_MSG_INFO');
				db.where({ friendUserName: friendName }).saveData({ status: '1' }, function(result) {});

				//获取首页，并触发首页时间
				var contactsPage = plus.webview.getWebviewById("index.html");
				mui.fire(contactsPage, 'updateMyFrends', {});

				//执行mui封装好的窗口关闭逻辑；
				old_back();
			}

			function SendBtn(event) {
				if(event.keyCode == 13) {
					sendMsgOnYTX();
				}
			}

			function sendMsgOnYTX() {
				var textMsg = document.getElementById("msg-text").value;

				var emojiCount = 0; //文本框中所含有的表情数
				for(var i = 0; i < textMsg.length; i++) {
					if("[" == textMsg.charAt(i)) {
						emojiCount++;
					}
				}

				for(var i = 0; i < emojiCount; i++) {
					//将textMsg做格式化表情处理
					var leftBracketIndex = textMsg.indexOf("[");
					var rightBracketIndex = textMsg.indexOf("]");
					var emojiName = textMsg.substring(leftBracketIndex + 1, rightBracketIndex);
					var imgSrcNum = getNumByName(emojiName);
					var leftText = textMsg.substring(0, leftBracketIndex);
					var rightText = textMsg.substring(rightBracketIndex + 1);

					textMsg = leftText + "<img src=\"arclist/" + imgSrcNum + ".gif\"></img>" + rightText;
				}

				//新建消息体对象
				var obj = new RL_YTX.MsgBuilder();
				//设置自定义消息id
				var times = new Date().getTime();
				obj.setId(times);

				obj.setText(textMsg);
				//设置发送的消息类型1文本消息4 图片消息6 附件消息
				obj.setType(1);
				//设置接收者
				obj.setReceiver(friendName);

				RL_YTX.sendMsg(obj, function() {
					//发送消息成功
					var db = new lanxDB('MSG_DATABASE');
					db.switchTable('IM_MSG_INFO').insertData([{
						friendUserName: friendName,
						type: "1",
						msg: textMsg,
						times: times + "",
						msgtype: "1",
						status: "1"
					}]);

					/*send({
							sender: 'self',
							type: 'text',
							content: ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>')
						});*/

					send({
						sender: 'self',
						type: 'text',
						content: textMsg
					});

					ui.boxMsgText.value = '';
					mui.trigger(ui.boxMsgText, 'input', null);
				}, function(obj) {
					//失败
					//console.log("发送失败" + "----->错误码： " + obj.code + "; 错误描述：" + obj.msg);

				}, function(sended, total) {
					//发送图片或附件时的进度条
					//如果发送文本消息，可以不传该参数
				});
			}

			var record = [];
			var self;

			//标记未读消息数
			function signUnreadMsgNum() {
				var db = openDatabase('MSG_DATABASE', '1.0.0', 'MSG_DATABASE', 5 * 1024 * 1024);
				var sql = "select * from IM_MSG_INFO where friendUserName = '" + friendName + "' and status = '2' ";
				db.transaction(function(tx) {
					tx.executeSql(sql, [],
						function(tx, result) {
							unreadMsgNum = result.rows.length;
							if(unreadMsgNum > 10) {
								document.getElementById("unreadMsgNum").style.display = "block";
								document.getElementById("unreadMsgNum").innerText = unreadMsgNum - 10 + "条未读";
							}
						}, null);
				});
			};

			//拼接消息数组
			function connectMsgArray(result) {
				for(var i = 0; i < result.rows.length; i++) {
					var sendOrReciveType = result.rows.item(i).type;
					var msgType = result.rows.item(i).msgtype;

					if(msgType == "1") {
						msgType = "text"
					} else if(msgType == "4") {
						msgType = "image"
					} else if(msgType == "2") {
						msgType = "sound";
					} else {
						msgType = "video";
					}

					if(sendOrReciveType == "1") {
						//在数组起始位置插入元素
						record.splice(0, 0, {
							sender: 'self',
							type: msgType,
							content: result.rows.item(i).msg
						});
						bindMsgList();
					} else {
						//在数组起始位置插入元素
						record.splice(0, 0, {
							sender: 'zs',
							type: msgType,
							content: result.rows.item(i).msg
						});
						bindMsgList();
					}
				}
			}

			//查询数据库，获取历史记录，并显示到页面
			function showMsgHistory() {
				var db = openDatabase('MSG_DATABASE', '1.0.0', 'MSG_DATABASE', 5 * 1024 * 1024);
				var sql = "select * from IM_MSG_INFO where friendUserName = '" + friendName + "' order by id desc LIMIT 10 OFFSET " + startNum;

				db.transaction(function(tx) {
					tx.executeSql(sql, [],
						function(tx, result) {
							if(result.rows.length == 0) {
								if(startNum != 0) {
									//当startNum为0时，则为刚进入聊天窗口，并且与该好友没有聊天历史
									//当startNum不为0时，弹出提示
									mui.toast("没有聊天历史了");
								}
							} else if(result.rows.length > 0) {
								//拼接消息数组
								connectMsgArray(result);
							}

							startNum = startNum + 10;
						}, null);
				});
			}

			//获取未读消息记录
			function showUnreadMsg(unreadMsgNum) {
				var db = openDatabase('MSG_DATABASE', '1.0.0', 'MSG_DATABASE', 5 * 1024 * 1024);
				var sql = "select * from IM_MSG_INFO where friendUserName = '" + friendName + "' order by id desc LIMIT " + unreadMsgNum + " OFFSET " + startNum;
				db.transaction(function(tx) {
					tx.executeSql(sql, [],
						function(tx, result) {
							startNum = startNum + unreadMsgNum;

							if(result.rows.length == 0) {
								return;
							} else if(result.rows.length > 0) {
								//拼接消息数组
								connectMsgArray(result);
							}
						}, null);
				});
			}

			mui.plusReady(function() {
				plus.nativeUI.closeWaiting(); //关闭其他等待框				
				self = plus.webview.currentWebview();
				friendId = self.userId;
				friendName = self.friendName;
				friendAvatar = self.friendImg;

				asyncAjaxSend(serverLogin + "GetUserInfoById", { userId: friendId }, function(result) {
					if(result.status == "1") {
						fAvatar = ServerHost + result.data.avatar;
						localStorage.setItem("avatar" + friendId, fAvatar);
					}
				}, function() {});

				var UserInfo = JSON.parse(localStorage.getItem("UserInfo"));
				gid = self.gid;
				title.innerHTML = self.title;
				avatar = UserInfo.avatar;

				//登录“云通讯”平台
				YTXinit();

				//标记未读消息数
				signUnreadMsgNum();

				//查询数据库，获取历史记录，并显示到页面
				showMsgHistory();

				//调用“登录”函数
				login(UserInfo.userName);

				//“发送”点击事件
				document.getElementById("fasong").addEventListener("tap", function() {
					sendMsgOnYTX();
				});

				//“未读消息”点击事件
				document.getElementById("unreadMsgNum").addEventListener("tap", function() {
					document.getElementById("unreadMsgNum").style.display = "none";
					showUnreadMsg(unreadMsgNum - 10);
				});

				//监听下滑事件，添加消息历史
				document.getElementById("msg-list").addEventListener("swipedown", function() {
					//将未读消息<span>标签样式去掉
					document.getElementById("unreadMsgNum").style.display = "none";

					showMsgHistory();
				});

				//点击拍照
				//				document.getElementById("camera").addEventListener("tap",function()
				//				{
				//					var cmr = plus.camera.getCamera();
				//					cmr.captureImage(function(path) 
				//					{
				//						console.log("拍照后path = " + path);
				//						//将图片压缩
				//						compressImage(path);
				//					}, function(err) {});
				//				});

				//点击从相册中选择图片
				//				document.getElementById("picture").addEventListener("tap",function()
				//				{
				//					plus.gallery.pick(function(path) 
				//					{
				//						console.log("进入选择图片路径 path = " + path);
				//						//将图片压缩
				//						compressImage(path);
				//					}, 
				//					function(err) 
				//					{
				//						console.log("选择图片失败");
				//					},null);
				//				});

				//点击录像
				document.getElementById("video").addEventListener("tap", function() {
					//调用底层，调出底层拍摄视频页面
					plus.plugintest.PluginTestFunctionArrayArgu(function(result) {}, function(result) {});
				});

				//接收OC传来的参数
				document.addEventListener("endVideo", onEventFunc, false);

				function onEventFunc(args) {
					alert("录像结束");
					var btnArray = ['取消', '使用'];
					mui.confirm('是否发送该录像？', ' ', btnArray, function(e) {
						if(e.index == 1) {
							if(mui.os.ios) {
								sendVideoMsgForIOS();
							} else {
								var videoPath = ""; //后台所传的视频地址
								sendVideoMsg(videoPath);
							}

						}
					});
				};

				self.setStyle({
					softinputMode: "adjustResize"
				});
				var showKeyboard = function() {
					if(mui.os.ios) {
						var webView = plus.webview.currentWebview().nativeInstanceObject();
						webView.plusCallMethod({
							"setKeyboardDisplayRequiresUserAction": false
						});
					} else {
						var Context = plus.android.importClass("android.content.Context");
						var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
						var main = plus.android.runtimeMainActivity();
						var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
						imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
						//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
						imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
					}
				};

				ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
				var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;

				window.addEventListener('resize', function() {
					ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
				}, false);

				//				document.getElementById("micImg").addEventListener('tap', function(event) 
				//				{
				//					document.getElementById("footerDivForText").style.display = "none";
				//					document.getElementById("footerDivforSound").style.display = "block";
				//				});

				document.getElementById("textLabel").addEventListener("tap", function() {
					document.getElementById("footerDivForText").style.display = "block";
					document.getElementById("footerDivforSound").style.display = "none";
				});

				function msgTextFocus() {
					ui.boxMsgText.focus();
					setTimeout(function() {
						ui.boxMsgText.focus();
					}, 150);
				}

				var setSoundAlertVisable = function(show) {
					if(show) {
						ui.boxSoundAlert.style.display = 'block';
						ui.boxSoundAlert.style.opacity = 1;
					} else {
						ui.boxSoundAlert.style.opacity = 0;
						//fadeOut 完成再真正隐藏
						setTimeout(function() {
							ui.boxSoundAlert.style.display = 'none';
						}, 200);
					}
				};

				var recordCancel = false;
				var recorder = null;
				var audio_tips = document.getElementById("audio_tips");
				var startTimestamp = null;
				var stopTimestamp = null;
				var stopTimer = null;
				ui.boxMsgSound.addEventListener('hold', function(event) {
					recordCancel = false;
					if(stopTimer) clearTimeout(stopTimer);
					audio_tips.innerHTML = "手指上划，取消发送";
					ui.boxSoundAlert.classList.remove('rprogress-sigh');
					setSoundAlertVisable(true);
					recorder = plus.audio.getRecorder();
					if(recorder == null) {
						plus.nativeUI.toast("不能获取录音对象");
						return;
					}
					startTimestamp = (new Date()).getTime();
					recorder.record({
						filename: "_doc/audio/"
					}, function(path) {

						console.log("path =====> " + path);

						if(recordCancel) return;

						if(mui.os.android) {
							sendVoiceMsg(path);
						} else {
							var localPath = plus.io.convertLocalFileSystemURL(path);
							plus.plugintest.PluginTestFunctionStartRecord(localPath,
								function(result) {
									sendVoiceMsgForIOS();
								},
								function(result) {});
						}
					}, function(e) {
						plus.nativeUI.toast("录音时出现异常: " + e.message);
					});
				}, false);

				ui.boxMsgSound.addEventListener('release', function(event) {
					if(audio_tips.classList.contains("cancel")) {
						audio_tips.classList.remove("cancel");
						audio_tips.innerHTML = "手指上划，取消发送";
					}

					stopTimestamp = (new Date()).getTime();
					if(stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
						audio_tips.innerHTML = "录音时间太短";
						ui.boxSoundAlert.classList.add('rprogress-sigh');
						recordCancel = true;
						stopTimer = setTimeout(function() {
							setSoundAlertVisable(false);
						}, 800);
					} else {
						setSoundAlertVisable(false);
					}
					recorder.stop();
				}, false);

				ui.body.addEventListener('drag', function(event) {
					if(Math.abs(event.detail.deltaY) > 50) {
						if(!recordCancel) {
							recordCancel = true;
							if(!audio_tips.classList.contains("cancel")) {
								audio_tips.classList.add("cancel");
							}
							audio_tips.innerHTML = "松开手指，取消发送";
						}
					} else {
						if(recordCancel) {
							recordCancel = false;
							if(audio_tips.classList.contains("cancel")) {
								audio_tips.classList.remove("cancel");
							}
							audio_tips.innerHTML = "手指上划，取消发送";
						}
					}
				}, false);

				ui.boxMsgSound.addEventListener("touchstart", function(e) {
					e.preventDefault();
				});

				var focus = false;
				ui.boxMsgText.addEventListener('tap', function(event) {
					ui.boxMsgText.focus();
					setTimeout(function() {
						ui.boxMsgText.focus();
					}, 0);
					focus = true;
					setTimeout(function() {
						focus = false;
					}, 1000);
					event.detail.gesture.preventDefault();
				}, false);

				//点击消息列表，关闭键盘
				ui.areaMsgList.addEventListener('click', function(event) {
					if(!focus) {
						ui.boxMsgText.blur();
					}
				})
			});
		</script>
	</body>

</html>